#!/usr/bin/env -S execlineb -W

# Build and push website from a specific commit or HEAD of current branch to
# the "pages" branch on Codeberg for deployment by <grebedoc.dev>.

define > foreground

# Pass an optional commit hash to deploy.
importas -D "HEAD" commit_ref 1
backtick -E commit { git rev-parse $commit_ref }

backtick -E tmp_id { pipeline { uuidgen } tr A-Z a-z }
define base "/tmp/uk/axvr/www/${tmp_id}"

define source "${base}/source"
$> { git clone --no-tags . $source }
$> { git -C $source switch --detach $commit }

define deploy "${base}/deploy"
$> { git clone --no-tags --depth 1 --branch pages \
         "ssh://git@codeberg.org/axvr/website.git" $deploy }

$> { cd $source do/build }
$> { rsync -avh --checksum --prune-empty-dirs --recursive --itemize-changes \
           --delete-during --exclude .git ${source}/.dist/ $deploy }

$> { git -C $deploy add . }
$> { git -C $deploy commit -S -m "Update website from: ${commit}" }
$> { git -C $deploy push -u upstream pages }
