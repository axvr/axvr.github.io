name: Build website
on: [push, workflow_dispatch]

jobs:
  build:
    name: Build website
    env:
      CLOUDFRONT_DIST_ID: ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }}
      S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Install Clojure tools
        uses: DeLaGuardo/setup-clojure@5.1
        with:
          cli: '1.11.1.1113'

      - name: Build website
        run: |
          git fetch origin dist --depth=1
          git worktree add dist origin/dist
          git -C dist rm -r .
          clojure -X:build
          cp -r resources/dist/* dist/

      - name: Commit changes
        uses: EndBug/add-and-commit@v7
        with:
          cwd: dist/
          branch: dist
          default_author: github_actions
          message: 'Deploy website'
          add: '*'

      - name: Clean up
        run: git worktree remove --force dist
